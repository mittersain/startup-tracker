generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Organizations (Multi-tenant)
// ==========================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  plan      String   @default("free") // free, pro, enterprise
  settings  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users        User[]
  startups     Startup[]
  emails       Email[]
  activityLogs ActivityLog[]
  scoreAlerts  ScoreAlert[]

  @@map("organizations")
}

// ==========================================
// Users & Authentication
// ==========================================

model User {
  id                   String    @id @default(uuid())
  organizationId       String    @map("organization_id")
  email                String    @unique
  passwordHash         String    @map("password_hash")
  name                 String
  role                 String    @default("analyst") // admin, partner, analyst, viewer
  avatarUrl            String?   @map("avatar_url")
  outlookRefreshToken  String?   @map("outlook_refresh_token")
  outlookConnectedAt   DateTime? @map("outlook_connected_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  ownedStartups        Startup[]            @relation("StartupOwner")
  uploadedDecks        PitchDeck[]
  confirmedContacts    StartupContact[]     @relation("ContactConfirmer")
  syncedEmails         Email[]
  createdInvestments   Investment[]
  manualScoreEvents    ScoreEvent[]         @relation("ManualScoreEvents")
  activityLogs         ActivityLog[]
  startupAssignmentsBy StartupAssignment[]  @relation("AssignedBy")
  startupAssignments   StartupAssignment[]  @relation("AssignedTo")
  refreshTokens        RefreshToken[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ==========================================
// Startups & Deals
// ==========================================

model Startup {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  website        String?
  domain         String?
  description    String?
  status         String   @default("reviewing") // reviewing, due_diligence, invested, passed, archived
  stage          String?  // pre_seed, seed, series_a, series_b, series_c, growth
  sector         String?  // fintech, healthtech, saas, ecommerce, edtech, deeptech, consumer, enterprise, marketplace, climate, other
  ownerId        String   @map("owner_id")

  // Scoring
  baseScore        Int?      @map("base_score")
  currentScore     Int?      @map("current_score")
  scoreTrend       String    @default("stable") @map("score_trend") // up, down, stable
  scoreTrendDelta  Float     @default(0) @map("score_trend_delta")
  scoreBreakdown   Json?     @map("score_breakdown")
  scoreUpdatedAt   DateTime? @map("score_updated_at")

  // Business model analysis
  businessModelAnalysis    Json?   @map("business_model_analysis") // AI-generated analysis
  consolidatedDeckAnalysis Json?   @map("consolidated_deck_analysis") // Merged analysis from all pitch decks
  draftReply               String? @map("draft_reply") // Draft email reply for founder
  draftReplyStatus         String  @default("pending") @map("draft_reply_status") // pending, approved, sent
  analysisUpdatedAt        DateTime? @map("analysis_updated_at")

  // Extracted data
  founders     Json?
  metrics      Json?
  tags         Json?
  notes        String?
  customFields Json?    @map("custom_fields")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner        User         @relation("StartupOwner", fields: [ownerId], references: [id])

  pitchDecks             PitchDeck[]
  contacts               StartupContact[]
  emails                 Email[]
  investments            Investment[]
  scoreEvents            ScoreEvent[]
  startupMetrics         StartupMetric[]
  communicationMetrics   CommunicationMetrics?
  assignments            StartupAssignment[]
  activityLogs           ActivityLog[]
  scoreAlerts            ScoreAlert[]
  evaluation             StartupEvaluation?

  @@index([organizationId])
  @@index([ownerId])
  @@index([status])
  @@index([currentScore])
  @@map("startups")
}

model StartupAssignment {
  userId      String   @map("user_id")
  startupId   String   @map("startup_id")
  accessLevel String   @default("view") @map("access_level") // view, edit
  assignedBy  String   @map("assigned_by")
  assignedAt  DateTime @default(now()) @map("assigned_at")

  user       User    @relation("AssignedTo", fields: [userId], references: [id], onDelete: Cascade)
  startup    Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  assignedByUser User @relation("AssignedBy", fields: [assignedBy], references: [id])

  @@id([userId, startupId])
  @@map("startup_assignments")
}

// ==========================================
// Pitch Decks
// ==========================================

model PitchDeck {
  id            String   @id @default(uuid())
  startupId     String   @map("startup_id")
  fileUrl       String   @map("file_url")
  fileName      String   @map("file_name")
  fileSize      Int      @map("file_size")
  mimeType      String   @map("mime_type")
  extractedText String?  @map("extracted_text")
  extractedData Json?    @map("extracted_data")
  aiAnalysis    Json?    @map("ai_analysis")
  uploadedBy    String   @map("uploaded_by")
  uploadedAt    DateTime @default(now()) @map("uploaded_at")

  startup  Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id])

  @@index([startupId])
  @@map("pitch_decks")
}

// ==========================================
// Scoring System
// ==========================================

model ScoreEvent {
  id         String   @id @default(uuid())
  startupId  String   @map("startup_id")
  timestamp  DateTime @default(now())
  source     String   // deck, email, meeting, research, manual, system
  sourceId   String?  @map("source_id")
  category   String   // team, market, product, traction, deal, communication, momentum, red_flag
  signal     String
  impact     Float    // -10 to +10
  confidence Float    @default(1.0) // 0 to 1
  evidence   String?
  analyzedBy String   @map("analyzed_by") // ai, user
  userId     String?  @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  user    User?   @relation("ManualScoreEvents", fields: [userId], references: [id])

  @@index([startupId, timestamp(sort: Desc)])
  @@index([category])
  @@map("score_events")
}

model StartupMetric {
  id         String   @id @default(uuid())
  startupId  String   @map("startup_id")
  metricName String   @map("metric_name") // arr, mrr, users, growth_rate, etc.
  value      Float
  unit       String?
  reportedAt DateTime @map("reported_at")
  source     String   // deck, email, call
  sourceId   String?  @map("source_id")
  createdAt  DateTime @default(now()) @map("created_at")

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId, metricName, reportedAt])
  @@map("startup_metrics")
}

model CommunicationMetrics {
  startupId            String   @id @map("startup_id")
  avgResponseTimeHours Float?   @map("avg_response_time_hours")
  responseRate         Float?   @map("response_rate")
  totalEmails          Int      @default(0) @map("total_emails")
  proactiveUpdates     Int      @default(0) @map("proactive_updates")
  missedDeadlines      Int      @default(0) @map("missed_deadlines")
  inconsistencies      Json?
  metricsShared        Json?    @map("metrics_shared")
  lastCalculated       DateTime @default(now()) @map("last_calculated")

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@map("communication_metrics")
}

// ==========================================
// Email Integration
// ==========================================

model StartupContact {
  id          String    @id @default(uuid())
  startupId   String    @map("startup_id")
  email       String
  name        String?
  role        String?
  matchType   String    @map("match_type") // confirmed, domain, inferred, pending
  confirmedBy String?   @map("confirmed_by")
  confirmedAt DateTime? @map("confirmed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  confirmer User?   @relation("ContactConfirmer", fields: [confirmedBy], references: [id])

  @@unique([startupId, email])
  @@index([email])
  @@map("startup_contacts")
}

model Email {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  startupId       String?  @map("startup_id")
  userId          String   @map("user_id")
  outlookId       String   @unique @map("outlook_id")
  conversationId  String?  @map("conversation_id")
  subject         String
  fromAddress     String   @map("from_address")
  fromName        String?  @map("from_name")
  toAddresses     Json     @map("to_addresses")
  ccAddresses     Json?    @map("cc_addresses")
  bodyPreview     String   @map("body_preview")
  bodyHtml        String?  @map("body_html")
  receivedAt      DateTime @map("received_at")
  direction       String   // inbound, outbound
  matchConfidence Float    @default(0) @map("match_confidence")
  hasAttachments  Boolean  @default(false) @map("has_attachments")
  isRead          Boolean  @default(false) @map("is_read")
  aiAnalysis      Json?    @map("ai_analysis")
  syncedAt        DateTime @default(now()) @map("synced_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  startup      Startup?     @relation(fields: [startupId], references: [id], onDelete: SetNull)
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId, receivedAt(sort: Desc)])
  @@index([startupId, receivedAt(sort: Desc)])
  @@index([fromAddress])
  @@map("emails")
}

// ==========================================
// Investments
// ==========================================

model Investment {
  id         String   @id @default(uuid())
  startupId  String   @map("startup_id")
  amount     Float
  currency   String   @default("USD")
  valuation  Float?
  instrument String   // safe, equity, convertible_note, other
  date       DateTime
  terms      Json?
  notes      String?
  createdBy  String   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [createdBy], references: [id])

  @@index([startupId])
  @@map("investments")
}

// ==========================================
// Activity & Notifications
// ==========================================

model ActivityLog {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  startupId      String?  @map("startup_id")
  action         String
  details        Json?
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  startup      Startup?     @relation(fields: [startupId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([startupId, createdAt(sort: Desc)])
  @@map("activity_logs")
}

model ScoreAlert {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  startupId      String   @map("startup_id")
  type           String   // major_increase, major_decrease, red_flag, milestone
  previousScore  Int      @map("previous_score")
  newScore       Int      @map("new_score")
  trigger        String
  urgency        String   // low, medium, high
  read           Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  startup      Startup      @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([organizationId, read, createdAt(sort: Desc)])
  @@map("score_alerts")
}

// ==========================================
// Proposal Queue (for email-sourced startups)
// ==========================================

model ProposalQueue {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id") // user who triggered the sync

  // Email metadata
  emailMessageId String   @unique @map("email_message_id") // prevent duplicates
  emailSubject   String   @map("email_subject")
  emailFrom      String   @map("email_from")
  emailFromName  String?  @map("email_from_name")
  emailDate      DateTime @map("email_date")
  emailPreview   String   @map("email_preview") // body preview for context
  attachments    Json?    // Array of {filename, contentType, size, contentBase64}

  // Extracted proposal data
  startupName    String   @map("startup_name")
  description    String?
  website        String?
  founderName    String?  @map("founder_name")
  founderEmail   String?  @map("founder_email")
  askAmount      String?  @map("ask_amount") // funding ask
  stage          String?  // pre_seed, seed, series_a, etc.
  extractedData  Json?    @map("extracted_data") // full AI extraction

  // AI analysis
  confidence     Float    @default(0) // 0-1 confidence this is a real proposal
  aiReason       String?  @map("ai_reason") // why AI thinks this is/isn't a proposal

  // Queue status
  status         String   @default("pending") // pending, approved, rejected, snoozed
  reviewedAt     DateTime? @map("reviewed_at")
  reviewedBy     String?   @map("reviewed_by")
  rejectionReason String?  @map("rejection_reason")

  // Snooze tracking
  snoozedUntil   DateTime? @map("snoozed_until") // When to check for progress
  snoozeCount    Int      @default(0) @map("snooze_count") // Number of times snoozed
  lastProgressCheck DateTime? @map("last_progress_check") // Last AI progress evaluation
  progressNotes  String?  @map("progress_notes") // AI notes on progress

  // If approved, link to created startup
  createdStartupId String? @map("created_startup_id")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([organizationId, status, createdAt(sort: Desc)])
  @@index([userId])
  @@index([founderEmail])
  @@map("proposal_queue")
}

// ==========================================
// Startup Evaluation & Scoring
// ==========================================

model StartupEvaluation {
  id             String   @id @default(uuid())
  startupId      String   @unique @map("startup_id")
  organizationId String   @map("organization_id")

  // Stage tracking
  stage          String   @default("presentation_review") // presentation_review, qa_round_1, qa_round_2, qa_round_3, scoring_complete
  isPostRevenue  Boolean  @default(false) @map("is_post_revenue")

  // Q&A tracking (max 3 rounds, max 10 questions total)
  totalQuestionsAsked   Int @default(0) @map("total_questions_asked")
  totalQuestionsAnswered Int @default(0) @map("total_questions_answered")
  qaRoundsCompleted     Int @default(0) @map("qa_rounds_completed")

  // Final scores (out of 100)
  totalScore     Int?     @map("total_score")

  // Thiel Criteria (50 points)
  thielScore           Int? @map("thiel_score")
  contrarianInsight    Json? @map("contrarian_insight") // {score, maxScore, commentary}
  productAdvantage10x  Json? @map("product_advantage_10x")
  monopolyPotential    Json? @map("monopoly_potential")
  moatDurability       Json? @map("moat_durability")
  longTermViability    Json? @map("long_term_viability")
  founderQuality       Json? @map("founder_quality")
  teamLeverage         Json? @map("team_leverage")
  timing               Json? @map("timing")
  distributionAdvantage Json? @map("distribution_advantage")
  missionPurpose       Json? @map("mission_purpose")

  // Founder & Team (15 points, or 22 for pre-revenue)
  founderTeamScore     Int? @map("founder_team_score")
  determination        Json? @map("determination")
  founderMarketFit     Json? @map("founder_market_fit")
  cofounderChemistry   Json? @map("cofounder_chemistry")
  adaptability         Json? @map("adaptability")

  // Market Opportunity (10 points)
  marketScore          Int? @map("market_score")
  tamSizeGrowth        Json? @map("tam_size_growth")
  winnerTakeAll        Json? @map("winner_take_all")
  competitiveLandscape Json? @map("competitive_landscape")

  // Traction & Metrics (15 points for post-revenue, 0 for pre-revenue)
  tractionScore        Int? @map("traction_score")
  revenueGrowth        Json? @map("revenue_growth")
  userCustomerGrowth   Json? @map("user_customer_growth")
  unitEconomics        Json? @map("unit_economics")
  retentionChurn       Json? @map("retention_churn")

  // Business Model & Scalability (10 points)
  businessModelScore   Int? @map("business_model_score")
  scalability          Json? @map("scalability")
  pathToProfitability  Json? @map("path_to_profitability")
  capitalEfficiency    Json? @map("capital_efficiency")

  // Overall assessment
  overallCommentary    String? @map("overall_commentary")
  strengths            Json?   // Array of key strengths
  concerns             Json?   // Array of key concerns
  recommendation       String? // strong_invest, invest, consider, pass

  scoredAt       DateTime? @map("scored_at")
  scoredBy       String?   @map("scored_by") // ai or user_id
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  startup     Startup           @relation(fields: [startupId], references: [id], onDelete: Cascade)
  qaRounds    EvaluationQARound[]

  @@index([organizationId])
  @@index([totalScore])
  @@map("startup_evaluations")
}

model EvaluationQARound {
  id             String   @id @default(uuid())
  evaluationId   String   @map("evaluation_id")
  roundNumber    Int      @map("round_number") // 1, 2, or 3

  // Questions sent to founder
  questions      Json     // Array of {id, question, category, priority}
  questionCount  Int      @map("question_count")

  // Email tracking
  emailSentAt    DateTime? @map("email_sent_at")
  emailMessageId String?   @map("email_message_id")

  // Responses from founder
  responses      Json?    // Array of {questionId, answer, answeredAt}
  responseReceivedAt DateTime? @map("response_received_at")

  // AI analysis of responses
  responseAnalysis Json?  @map("response_analysis")

  status         String   @default("draft") // draft, sent, answered, analyzed
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  evaluation  StartupEvaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@unique([evaluationId, roundNumber])
  @@map("evaluation_qa_rounds")
}

// ==========================================
// Rejected Emails (to prevent re-pickup)
// ==========================================

model RejectedEmail {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  emailAddress   String   @map("email_address") // Founder's email
  startupName    String?  @map("startup_name") // Original startup name
  reason         String?  // Why it was rejected
  rejectedAt     DateTime @default(now()) @map("rejected_at")
  rejectedBy     String   @map("rejected_by") // User who rejected

  @@unique([organizationId, emailAddress])
  @@index([organizationId])
  @@index([emailAddress])
  @@map("rejected_emails")
}
